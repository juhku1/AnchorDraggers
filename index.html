<title>AIS Map Pseudo-3D (Digitraffic + MapLibre)</title>
<meta name="viewport" content="width=device-width, initial-scale=1"/>

  <!-- MapLibre CSS -->
<link
rel="stylesheet"
href="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.css"
/>

  <!-- Hiljennetään favicon-404 -->
<link rel="icon" href="data:,">

<style>
@@ -22,23 +19,19 @@
background: #050812;
font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
}

#map {
width: 100vw;
height: 100vh;
position: relative;
background: #020818;
}

.vessel-svg-icon {
background: none !important;
border: none !important;
}

.attribution {
position: fixed;
      bottom: 4px;
      left: 4px;
      bottom: 4px; left: 4px;
background: white;
padding: 3px 8px;
font-size: 11px;
@@ -48,7 +41,6 @@
z-index: 2000;
pointer-events: none;
}

.flag-img {
width: 24px;
height: 18px;
@@ -58,12 +50,9 @@
border-radius: 3px;
background: #eee;
}

    /* Pseudo-3D horisontti yläreunaan */
.sky-overlay {
position: fixed;
      top: 0;
      left: 0;
      top: 0; left: 0;
width: 100vw;
height: 35vh;
pointer-events: none;
@@ -74,12 +63,9 @@
rgba(5, 8, 18, 0)
);
}

    /* Vignette alaosaan, vähän “sumua” */
.ground-vignette {
position: fixed;
      bottom: 0;
      left: 0;
      bottom: 0; left: 0;
width: 100vw;
height: 25vh;
pointer-events: none;
@@ -102,7 +88,6 @@
Map © OpenStreetMap contributors.
</div>

  <!-- MapLibre JS -->
<script src="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.js"></script>
<script>
const DIGITRAFFIC_USER = "JuhaMatti/AISMapLibreDemo";
@@ -143,7 +128,7 @@
return mmsiCountry[prefix] || "";
}

    // --- Flag lookup for MMSI country (registration country) ---
    // --- Flag lookup ---
const countryNameToIso2 = {
"Finland": "FI",
"Sweden": "SE",
@@ -187,7 +172,7 @@
return `<img class="flag-img" src="https://flagcdn.com/24x18/${iso2.toLowerCase()}.png" alt="${iso2} flag" loading="lazy">`;
}

    // --- UN/LOCODE CSV ---
    // --- UN/LOCODE ---
let unlocodeMap = {};

function splitCsvLine(line) {
@@ -265,7 +250,7 @@
return `${entry.name}, ${entry.country}`;
}

    // --- Utility functions ---
    // --- Utility ---
function haversine(lat1, lon1, lat2, lon2) {
const R = 6371000;
const toRad = d => d * Math.PI / 180;
@@ -303,7 +288,7 @@
return (value === null || value === undefined || value === "") ? fallback : value;
}

    // --- Ship type, color and name ---
    // --- Ship type ---
function shipTypeColor(shipType) {
if (shipType === undefined || shipType === null) return "#888";
if (shipType >= 60 && shipType < 70) return "#3a9eea";    // passenger
@@ -342,26 +327,26 @@
     `;
}

    // --- MAP (MapLibre, pseudo-3D) ---
    // --- MapLibre (pseudo-3D) ---
const map = new maplibregl.Map({
container: 'map',
style: 'https://basemaps.cartocdn.com/gl/dark-matter-gl-style/style.json',
      center: [22.0, 60.2],   // Suomi
      center: [22.0, 60.2],
zoom: 6,
      pitch: 60,              // pseudo-3D kallistus
      pitch: 60,
bearing: 20,
attributionControl: false
});

map.addControl(new maplibregl.NavigationControl(), 'top-right');

    // --- AIS markers state ---
    // --- AIS state ---
let loading = false;
    let firstFit = true;
const vesselState = {};
const vesselMetadataByMmsi = {};
let metadataLoaded = false;
    const vesselMarkers = {}; // mmsi -> { marker, element }
    const vesselMarkers = {}; // mmsi -> {marker, element}
    let firstCenter = true;

async function fetchVesselMetadata() {
if (metadataLoaded) return;
@@ -402,8 +387,9 @@
});
if (!res.ok) throw new Error("HTTP " + res.status + " " + res.statusText);
const data = await res.json();
        console.log("AIS features:", data.features ? data.features.length : 0);

        // Päivitä laskettu nopeus jokaiselle alukselle
        // Lasketaan liikepohjainen nopeus
data.features.forEach(feature => {
const props = feature.properties || {};
const mmsi = props.mmsi || feature.mmsi;
@@ -434,21 +420,19 @@
}
});

        const seenMmsi = new Set();
        let bounds = null;
        // Luo/päivitä markkerit
        let anyPosition = null;

data.features.forEach(feature => {
const props = feature.properties || {};
const mmsi = props.mmsi || feature.mmsi;
if (!mmsi) return;

const lat = feature.geometry.coordinates[1];
const lon = feature.geometry.coordinates[0];
          seenMmsi.add(mmsi);
          anyPosition = anyPosition || [lon, lat];

const meta = vesselMetadataByMmsi[mmsi] || {};
const sog = (typeof props.sog === "number" ? props.sog : undefined);

let calcSpeedKnots = (vesselState[mmsi] && typeof vesselState[mmsi].lastCalcSpeedKnots === "number")
? vesselState[mmsi].lastCalcSpeedKnots
: null;
@@ -464,14 +448,12 @@
const shipType = meta.shipType;
const color = shipTypeColor(shipType);
const svgIcon = vesselSvg(speed, angle, color);

const name = meta.name || props.name || "Unknown vessel";

let popupHtml = "";
popupHtml += `<strong>${safe(name)}</strong><br>`;
popupHtml += `<strong>MMSI:</strong> ${safe(mmsi)}<br>`;

          // Registration country/flag
const regCountry = getMmsiCountry(mmsi) || "–";
const regIso2 = getCountryIso2FromMmsiCountry(regCountry);
const regFlag = regIso2 ? flagImgTag(regIso2) : "";
@@ -480,7 +462,6 @@
if (meta.imo) popupHtml += `<strong>IMO:</strong> ${meta.imo}<br>`;
if (meta.callSign) popupHtml += `<strong>Callsign:</strong> ${meta.callSign}<br>`;

          // Destination decoding
if (meta.destination) {
const decoded = decodeDestination(meta.destination);
if (decoded) {
@@ -513,61 +494,39 @@
}
popupHtml += `<strong>Position:</strong> ${formatLatLon(lat, lon)}<br>`;

          // Luo tai päivitä marker
let markerData = vesselMarkers[mmsi];
if (!markerData) {
const el = document.createElement('div');
el.className = "vessel-svg-icon";
el.innerHTML = svgIcon;

const popup = new maplibregl.Popup({ offset: 20 }).setHTML(popupHtml);

const marker = new maplibregl.Marker({ element: el })
.setLngLat([lon, lat])
.setPopup(popup)
.addTo(map);

vesselMarkers[mmsi] = { marker, element: el };
} else {
markerData.element.innerHTML = svgIcon;
markerData.marker.setLngLat([lon, lat]);
if (markerData.marker.getPopup()) {
markerData.marker.getPopup().setHTML(popupHtml);
            } else {
              markerData.marker.setPopup(new maplibregl.Popup({ offset: 20 }).setHTML(popupHtml));
}
}

          // Bounds ensimmäistä kertaa varten
          if (!bounds) {
            bounds = new maplibregl.LngLatBounds([lon, lat], [lon, lat]);
          } else {
            bounds.extend([lon, lat]);
          }
});

        // Poista vanhat alukset, joita ei enää näy
        for (const mmsi in vesselMarkers) {
          if (!seenMmsi.has(mmsi)) {
            vesselMarkers[mmsi].marker.remove();
            delete vesselMarkers[mmsi];
          }
        }

        if (firstFit && bounds) {
          map.fitBounds(bounds, { padding: 60, maxZoom: 9 });
          firstFit = false;
        // Ensimmäisellä kerralla zoomataan lähemmäs johonkin alukseen (jos löytyy)
        if (firstCenter && anyPosition) {
          map.flyTo({ center: anyPosition, zoom: 8, essential: true });
          firstCenter = false;
}

        console.log("AIS features:", data.features ? data.features.length : 0);
} catch (err) {
console.error("AIS data fetch failed:", err);
} finally {
loading = false;
}
}

    // Aloitetaan, kun karttastylen lataus valmis
    // Käynnistetään kun kartta on ladattu
map.on('load', () => {
loadMmsiCountry(() => {
loadUnlocode(() => {
